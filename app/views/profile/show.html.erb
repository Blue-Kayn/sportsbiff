<% content_for :title, "Your Profile - SportsBiff" %>

<div class="max-w-4xl mx-auto py-8 px-4">
  <h1 class="text-3xl font-bold text-white mb-2">Your Profile</h1>
  <p class="text-gray-400 mb-8">Manage your favorite sports and teams</p>

  <!-- Account Info -->
  <div class="bg-gray-800 rounded-xl p-6 mb-6">
    <h2 class="text-xl font-semibold text-white mb-4">Account</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <div class="text-gray-400 text-sm">Email</div>
        <div class="text-white"><%= current_user.email %></div>
      </div>
      <div>
        <div class="text-gray-400 text-sm">Plan</div>
        <div class="text-white capitalize"><%= current_user.subscription_tier %></div>
      </div>
      <div>
        <div class="text-gray-400 text-sm">Queries Today</div>
        <div class="text-white"><%= current_user.daily_query_count %> / <%= current_user.daily_limit %></div>
      </div>
      <div>
        <div class="text-gray-400 text-sm">Member Since</div>
        <div class="text-white"><%= current_user.created_at.strftime("%B %Y") %></div>
      </div>
    </div>
  </div>

  <!-- Favorite Sports -->
  <div class="bg-gray-800 rounded-xl p-6 mb-6">
    <h2 class="text-xl font-semibold text-white mb-4">Your Sports</h2>

    <%= form_with url: profile_update_sports_path, method: :patch, class: "space-y-4" do |f| %>
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <% @sports.each do |sport| %>
          <label class="relative cursor-pointer">
            <input type="checkbox"
                   name="sports[]"
                   value="<%= sport %>"
                   class="peer sr-only"
                   <%= 'checked' if @selected_sports.include?(sport) %>>
            <div class="bg-gray-700 border-2 border-gray-600 rounded-lg p-4 text-center transition-all
                        peer-checked:border-blue-500 peer-checked:bg-blue-500/10
                        hover:border-gray-500">
              <div class="text-2xl mb-1"><%= sport_emoji(sport) %></div>
              <div class="text-sm font-medium text-white"><%= sport_display_name(sport) %></div>
            </div>
          </label>
        <% end %>
      </div>

      <div class="pt-2">
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition">
          Update Sports
        </button>
      </div>
    <% end %>
  </div>

  <!-- Favorite Teams -->
  <div class="bg-gray-800 rounded-xl p-6 mb-6">
    <h2 class="text-xl font-semibold text-white mb-4">Your Teams</h2>

    <% if @selected_sports.empty? %>
      <p class="text-gray-400">Select some sports first to choose your teams.</p>
    <% else %>
      <%= form_with url: profile_update_teams_path, method: :patch, class: "space-y-6" do |f| %>
        <% @selected_sports.each do |sport| %>
          <div>
            <h3 class="text-lg font-medium text-white mb-3 flex items-center gap-2">
              <span><%= sport_emoji(sport) %></span>
              <span><%= sport_display_name(sport) %></span>
            </h3>

            <div class="max-h-64 overflow-y-auto border border-gray-700 rounded-lg p-2">
              <div class="flex flex-wrap gap-1">
                <% @teams_by_sport[sport]&.each do |team| %>
                  <label class="relative cursor-pointer" style="width: 52px; flex-shrink: 0;">
                    <input type="checkbox"
                           name="team_ids[]"
                           value="<%= team.api_id %>"
                           class="peer sr-only"
                           <%= 'checked' if @selected_team_ids.include?(team.api_id) %>>
                    <div class="bg-gray-700 border border-gray-600 rounded p-1 text-center transition-all
                                peer-checked:border-blue-500 peer-checked:bg-blue-500/20
                                hover:border-gray-500 flex flex-col items-center justify-center"
                         style="height: 52px;"
                         title="<%= team.name %>">
                      <% if team.logo_url.present? %>
                        <img src="<%= team.logo_url %>"
                             alt="<%= team.name %>"
                             style="width: 28px; height: 28px; object-fit: contain; flex-shrink: 0;">
                      <% else %>
                        <span class="text-xs text-gray-400"><%= team.name.split.map(&:first).join %></span>
                      <% end %>
                      <div class="text-[8px] text-gray-400 truncate w-full mt-0.5"><%= team.name.split.last %></div>
                    </div>
                    <div class="absolute -top-0.5 -right-0.5 w-3 h-3 rounded-full bg-blue-500 items-center justify-center hidden peer-checked:flex">
                      <svg class="w-2 h-2 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                      </svg>
                    </div>
                  </label>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <div class="pt-2">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition">
            Update Teams
          </button>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- Current Selection Summary -->
  <% if current_user.favorite_teams.any? %>
    <div class="bg-gray-800 rounded-xl p-6">
      <h2 class="text-xl font-semibold text-white mb-4">Current Selection</h2>
      <div class="space-y-3">
        <% current_user.favorite_sports.each do |sport| %>
          <% teams = current_user.teams_for_sport(sport) %>
          <% if teams.any? %>
            <div class="flex items-start gap-3">
              <span class="text-xl"><%= sport_emoji(sport) %></span>
              <div>
                <div class="text-sm text-gray-400"><%= sport_display_name(sport) %></div>
                <div class="flex flex-wrap gap-2 mt-1">
                  <% teams.each do |team| %>
                    <span class="bg-blue-600/20 text-blue-400 px-2 py-1 rounded text-sm">
                      <%= team["team_name"] %>
                    </span>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
