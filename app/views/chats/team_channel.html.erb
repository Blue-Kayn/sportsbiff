<% content_for :title, "#{@team&.name || 'Team'} - SportsBiff" %>

<div class="flex h-[calc(100vh-4rem)] w-full" style="background: var(--bg-primary);">
  <!-- Sidebar -->
  <%= render partial: "chats/sidebar", locals: { team_channels: @team_channels, chats: @chats, current_chat: @chat } %>

  <!-- Team Channel Content -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Team Header -->
    <% if @dashboard&.dig(:header).present? %>
      <div class="team-header">
        <% if @team&.logo_url.present? %>
          <img src="<%= @team.logo_url %>" alt="<%= @team.name %>" class="team-header-logo">
        <% end %>
        <div>
          <h1 class="team-header-name"><%= @dashboard[:header][:name] %></h1>
          <div class="team-header-record">
            <%= @dashboard[:header][:wins] %>-<%= @dashboard[:header][:losses] %><% if @dashboard[:header][:ties].to_i > 0 %>-<%= @dashboard[:header][:ties] %><% end %>
          </div>
          <div class="team-header-info">
            <%= @dashboard[:header][:division] %> &bull; #<%= @dashboard[:header][:division_rank] %> in Division
          </div>
        </div>
      </div>
    <% else %>
      <div class="team-header">
        <% if @team&.logo_url.present? %>
          <img src="<%= @team.logo_url %>" alt="<%= @team.name %>" class="team-header-logo">
        <% end %>
        <div>
          <h1 class="team-header-name"><%= @team&.name %></h1>
          <div class="team-header-info"><%= @team&.sport %> News & Updates</div>
        </div>
      </div>
    <% end %>

    <!-- Dashboard Content -->
    <div class="flex-1 overflow-y-auto">
      <% if @dashboard.present? && @dashboard.any? %>
        <div class="dashboard-grid">
          <!-- LEFT COLUMN -->
          <div class="dashboard-column">

            <!-- Next Game Card -->
            <% if @dashboard[:next_game].present? %>
              <div class="next-game-card animate-fade-in-up">
                <div class="card-header">
                  <div class="flex items-center">
                    <svg class="card-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Next Game
                  </div>
                </div>
                <div class="next-game-opponent" style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                  <% if @dashboard[:next_game][:opponent_logo].present? %>
                    <img src="<%= @dashboard[:next_game][:opponent_logo] %>" alt="<%= @dashboard[:next_game][:opponent_name] %>" style="width: 64px; height: 64px; object-fit: contain;">
                  <% end %>
                  <div>
                    <% if @dashboard[:next_game][:is_home] %><% else %>@ <% end %><%= @dashboard[:next_game][:opponent_name] %>
                  </div>
                </div>
                <div class="next-game-datetime">
                  <%= Date.parse(@dashboard[:next_game][:date]).strftime("%A, %B %d at %I:%M %p") rescue @dashboard[:next_game][:date] %>
                </div>
                <% if @dashboard[:next_game][:channel].present? %>
                  <div class="next-game-channel"><%= @dashboard[:next_game][:channel] %></div>
                <% end %>
                <% if @dashboard[:next_game][:spread].present? || @dashboard[:next_game][:over_under].present? %>
                  <div class="next-game-odds">
                    <% if @dashboard[:next_game][:spread].present? %>
                      <div class="odds-item">
                        <div class="odds-label">Spread</div>
                        <div class="odds-value"><%= @dashboard[:next_game][:spread] > 0 ? '+' : '' %><%= @dashboard[:next_game][:spread] %></div>
                      </div>
                    <% end %>
                    <% if @dashboard[:next_game][:over_under].present? %>
                      <div class="odds-item">
                        <div class="odds-label">O/U</div>
                        <div class="odds-value"><%= @dashboard[:next_game][:over_under] %></div>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- Injury Report Card -->
            <% if @dashboard[:injuries].present? && @dashboard[:injuries].any? %>
              <div class="glass-card animate-fade-in-up animate-delay-1">
                <div class="card-header">
                  <div class="flex items-center">
                    <svg class="card-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    Injury Report
                  </div>
                  <span style="font-size: 11px; color: var(--text-muted);"><%= @dashboard[:injuries].count %> players</span>
                </div>
                <div style="max-height: 280px; overflow-y: auto;">
                  <% grouped_injuries = @dashboard[:injuries].group_by { |i| i[:status] } %>
                  <% status_order = ['Out', 'Doubtful', 'Questionable', 'Probable', 'Scrambled'] %>
                  <% status_order.each do |status| %>
                    <% if grouped_injuries[status].present? %>
                      <div class="injury-group-header">
                        <span class="injury-status-dot <%= status.downcase %>"></span>
                        <%= status == 'Scrambled' ? 'Injury Report' : status %> (<%= grouped_injuries[status].count %>)
                      </div>
                      <% grouped_injuries[status].first(5).each do |injury| %>
                        <div class="injury-item">
                          <div>
                            <span class="injury-player"><%= injury[:name] %></span>
                            <span class="injury-position"><%= injury[:position] %></span>
                          </div>
                          <span class="injury-detail"><%= injury[:body_part] == 'Scrambled' ? 'Injury' : injury[:body_part] %></span>
                        </div>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>

            <!-- Recent Results Card -->
            <% if @dashboard[:recent_results].present? && @dashboard[:recent_results].any? %>
              <div class="glass-card animate-fade-in-up animate-delay-2">
                <div class="card-header">
                  <div class="flex items-center">
                    <svg class="card-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Recent Results
                  </div>
                </div>
                <% @dashboard[:recent_results].each do |game| %>
                  <div class="result-item">
                    <div class="result-indicator <%= game[:won] ? 'win' : 'loss' %>">
                      <%= game[:won] ? 'W' : 'L' %>
                    </div>
                    <span class="result-score"><%= game[:score] %></span>
                    <span class="result-date">
                      <%= Date.parse(game[:date]).strftime("%b %d") rescue game[:date] %>
                    </span>
                  </div>
                <% end %>
              </div>
            <% end %>

          </div>

          <!-- RIGHT COLUMN -->
          <div class="dashboard-column">

            <!-- Division Standings Card -->
            <% if @dashboard[:standings].present? && @dashboard[:standings].any? %>
              <div class="glass-card animate-fade-in-up animate-delay-1">
                <div class="card-header">
                  <div class="flex items-center">
                    <svg class="card-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>
                    </svg>
                    Division Standings
                  </div>
                </div>
                <% @dashboard[:standings].each do |team| %>
                  <div class="standings-row <%= team[:is_current] ? 'current-team' : '' %>">
                    <span class="standings-rank"><%= team[:rank] %></span>
                    <span class="standings-team"><%= team[:team] %></span>
                    <span class="standings-record">
                      <%= team[:wins] %>-<%= team[:losses] %><% if team[:ties].to_i > 0 %>-<%= team[:ties] %><% end %>
                    </span>
                    <% if team[:is_current] %>
                      <svg class="standings-arrow w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                      </svg>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- Betting Record Card -->
            <% if @dashboard[:betting_record].present? %>
              <div class="glass-card animate-fade-in-up animate-delay-2">
                <div class="card-header">
                  <div class="flex items-center">
                    <svg class="card-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Betting Trends
                  </div>
                </div>
                <div class="betting-grid">
                  <div class="betting-stat">
                    <div class="betting-label">ATS Record</div>
                    <div class="betting-value"><%= @dashboard[:betting_record][:ats_wins] %>-<%= @dashboard[:betting_record][:ats_losses] %></div>
                  </div>
                  <div class="betting-stat">
                    <div class="betting-label">O/U Record</div>
                    <div class="betting-value"><%= @dashboard[:betting_record][:overs] %>O / <%= @dashboard[:betting_record][:unders] %>U</div>
                  </div>
                </div>
              </div>
            <% end %>

            <!-- Team Stats Card -->
            <% if @dashboard[:team_stats].present? %>
              <div class="glass-card animate-fade-in-up animate-delay-3">
                <div class="card-header">
                  <div class="flex items-center">
                    <svg class="card-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Team Stats
                  </div>
                </div>
                <div class="stat-item">
                  <span class="stat-name">Points Per Game</span>
                  <div class="flex items-center">
                    <span class="stat-value"><%= @dashboard[:team_stats][:points_per_game] %></span>
                    <% rank = @dashboard[:team_stats][:points_rank] %>
                    <span class="stat-rank <%= rank.to_i <= 10 ? 'good' : rank.to_i <= 20 ? 'avg' : 'bad' %>">#<%= rank %></span>
                  </div>
                </div>
                <div class="stat-item">
                  <span class="stat-name">Points Allowed</span>
                  <div class="flex items-center">
                    <span class="stat-value"><%= @dashboard[:team_stats][:points_allowed] %></span>
                    <% rank = @dashboard[:team_stats][:points_allowed_rank] %>
                    <span class="stat-rank <%= rank.to_i <= 10 ? 'good' : rank.to_i <= 20 ? 'avg' : 'bad' %>">#<%= rank %></span>
                  </div>
                </div>
                <div class="stat-item">
                  <span class="stat-name">Total Offense</span>
                  <div class="flex items-center">
                    <span class="stat-value"><%= number_with_delimiter(@dashboard[:team_stats][:total_offense_yards]) %> yds</span>
                    <% rank = @dashboard[:team_stats][:offense_rank] %>
                    <span class="stat-rank <%= rank.to_i <= 10 ? 'good' : rank.to_i <= 20 ? 'avg' : 'bad' %>">#<%= rank %></span>
                  </div>
                </div>
              </div>
            <% end %>

            <!-- Key Players Card -->
            <% if @dashboard[:key_players].present? && @dashboard[:key_players][:qb][:name] != "N/A" %>
              <div class="glass-card animate-fade-in-up animate-delay-4">
                <div class="card-header">
                  <div class="flex items-center">
                    <svg class="card-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Key Players
                  </div>
                </div>
                <% if @dashboard[:key_players][:qb][:name] != "N/A" %>
                  <div class="player-item">
                    <div class="player-position">QB</div>
                    <span class="player-name"><%= @dashboard[:key_players][:qb][:name] %></span>
                    <span class="player-stat"><%= @dashboard[:key_players][:qb][:yards] %> yds</span>
                  </div>
                <% end %>
                <% if @dashboard[:key_players][:rb][:name] != "N/A" %>
                  <div class="player-item">
                    <div class="player-position">RB</div>
                    <span class="player-name"><%= @dashboard[:key_players][:rb][:name] %></span>
                    <span class="player-stat"><%= @dashboard[:key_players][:rb][:yards] %> yds</span>
                  </div>
                <% end %>
                <% if @dashboard[:key_players][:wr][:name] != "N/A" %>
                  <div class="player-item">
                    <div class="player-position">WR</div>
                    <span class="player-name"><%= @dashboard[:key_players][:wr][:name] %></span>
                    <span class="player-stat"><%= @dashboard[:key_players][:wr][:yards] %> yds</span>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- Latest News Card -->
            <% if @dashboard[:news].present? && @dashboard[:news].any? %>
              <div class="glass-card animate-fade-in-up animate-delay-4">
                <div class="card-header">
                  <div class="flex items-center">
                    <svg class="card-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                    </svg>
                    Latest News
                  </div>
                </div>
                <% @dashboard[:news].each do |news| %>
                  <div class="news-item" style="margin-bottom: 8px;">
                    <div class="news-title"><%= news[:title] %></div>
                    <div class="news-time">
                      <% if news[:source].present? %><%= news[:source] %> &bull; <% end %>
                      <%= Time.parse(news[:updated]).strftime("%b %d") rescue "Recent" %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>

          </div>
        </div>

      <% else %>
        <!-- Fallback for non-NFL teams -->
        <div class="dashboard-grid" style="grid-template-columns: 1fr;">
          <div class="dashboard-column">
            <!-- Upcoming Games -->
            <% if @upcoming_games.present? %>
              <div class="glass-card animate-fade-in-up">
                <div class="card-header">
                  <div class="flex items-center">
                    <svg class="card-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Today's Games
                  </div>
                </div>
                <% @upcoming_games.each do |game| %>
                  <div class="result-item">
                    <span class="result-score"><%= game[:away][:name] %> @ <%= game[:home][:name] %></span>
                    <span class="result-date">
                      <% if game[:status] == "in" %>
                        <span class="animate-pulse-live" style="color: var(--accent-orange);">LIVE</span>
                        <span style="margin-left: 8px;"><%= game[:away][:score] %> - <%= game[:home][:score] %></span>
                      <% else %>
                        <%= game[:time] %>
                      <% end %>
                    </span>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- Recent Results -->
            <% if @recent_games.present? %>
              <div class="glass-card animate-fade-in-up animate-delay-1">
                <div class="card-header">
                  <div class="flex items-center">
                    <svg class="card-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Recent Results
                  </div>
                </div>
                <% @recent_games.each do |game| %>
                  <div class="result-item">
                    <span class="result-score"><%= game[:result] %></span>
                    <span class="result-date">
                      <% if game[:date].respond_to?(:strftime) %>
                        <%= game[:date].strftime("%b %d") %>
                      <% elsif game[:date].present? %>
                        <%= Date.parse(game[:date].to_s).strftime("%b %d") rescue game[:date] %>
                      <% end %>
                    </span>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- Latest News -->
            <div class="glass-card animate-fade-in-up animate-delay-2">
              <div class="card-header">
                <div class="flex items-center">
                  <svg class="card-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                  </svg>
                  Latest News
                </div>
              </div>

              <% if @news_items.present? %>
                <% @news_items.each do |news| %>
                  <div class="news-item" style="margin-bottom: 8px;">
                    <div class="news-title"><%= news[:headline] %></div>
                    <div class="news-time">
                      <% if news[:source].present? %><%= news[:source] %> &bull; <% end %>
                      <% if news[:published_at].respond_to?(:strftime) %>
                        <%= news[:published_at].strftime("%b %d, %Y") %>
                      <% elsif news[:published_at].present? %>
                        <%= Date.parse(news[:published_at].to_s).strftime("%b %d, %Y") rescue "Recent" %>
                      <% else %>
                        Recent
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% else %>
                <div class="text-center py-8" style="color: var(--text-muted);">
                  <svg style="width: 48px; height: 48px; margin: 0 auto 12px; opacity: 0.5;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                  </svg>
                  <p>No recent news about <%= @team&.name %> right now.</p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
